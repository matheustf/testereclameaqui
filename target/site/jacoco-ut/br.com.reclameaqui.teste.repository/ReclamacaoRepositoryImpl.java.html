<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReclamacaoRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">teste</a> &gt; <a href="index.source.html" class="el_package">br.com.reclameaqui.teste.repository</a> &gt; <span class="el_source">ReclamacaoRepositoryImpl.java</span></div><h1>ReclamacaoRepositoryImpl.java</h1><pre class="source lang-java linenums">package br.com.reclameaqui.teste.repository;

import static org.springframework.data.mongodb.core.aggregation.Aggregation.fields;
import static org.springframework.data.mongodb.core.aggregation.Aggregation.group;
import static org.springframework.data.mongodb.core.aggregation.Aggregation.match;
import static org.springframework.data.mongodb.core.aggregation.Aggregation.project;
import static org.springframework.data.mongodb.core.query.Criteria.where;

import java.util.List;
import java.util.stream.Collectors;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.aggregation.Aggregation;
import org.springframework.data.mongodb.core.aggregation.MatchOperation;

import br.com.reclameaqui.teste.documents.Cliente;
import br.com.reclameaqui.teste.documents.Reclamacao;
import br.com.reclameaqui.teste.dtos.ReclamantesRequestDTO;
import br.com.reclameaqui.teste.enums.TipoConsulta;

public class ReclamacaoRepositoryImpl implements ReclamacaoRepositoryCustom{
	
	 private final MongoTemplate mongoTemplate;
	 
	 private final MongoOperations mongoOperations;
	 

	    @Autowired
<span class="fc" id="L32">	    public ReclamacaoRepositoryImpl(MongoTemplate mongoTemplate, MongoOperations mongoOperations) {</span>
<span class="fc" id="L33">	        this.mongoTemplate = mongoTemplate;</span>
<span class="fc" id="L34">	        this.mongoOperations = mongoOperations;</span>
<span class="fc" id="L35">	    }</span>
	    
	    @Override
	    public List&lt;Cliente&gt; buscarClientesQueReclamam(TipoConsulta tipoConsulta, ReclamantesRequestDTO request) {
	        
	        
<span class="nc" id="L41">	        Aggregation newAggregation = Aggregation.newAggregation(tipoConsulta.matchOperation(request),</span>
<span class="nc" id="L42">	                group(fields().and(&quot;idCliente&quot;, &quot;idCliente&quot;))</span>
<span class="nc" id="L43">	                .first(&quot;idCliente&quot;).as(&quot;idCliente&quot;),project().andExclude(&quot;_id&quot;)</span>
	                );
	        
<span class="nc" id="L46">			List&lt;Cliente&gt; singleResults = mongoOperations.aggregate(newAggregation, Reclamacao.class, Reclamacao.class).getMappedResults().stream().map(item -&gt; item.getIdCliente()).collect(Collectors.toList());</span>
			
			
<span class="nc bnc" id="L49" title="All 2 branches missed.">			for (Cliente teste : singleResults) {</span>
<span class="nc" id="L50">				System.out.println(teste);</span>
<span class="nc" id="L51">			}</span>
			
<span class="nc" id="L53">			return singleResults;</span>
	    }

	    
	    /*
	         @Override
	    public List&lt;Reclamacao&gt; aggregate(ConsultaReclamacaoRequestDTO request) {
	        
	        
	        Aggregation newAggregation = Aggregation.newAggregation(match(where(&quot;endereco.cidade&quot;).is(request.getCidade()).and(&quot;empresa.nome&quot;).is(request.getEmpresa())),
	                group(fields().and(&quot;idCliente&quot;, &quot;idCliente&quot;))
	                .first(&quot;id&quot;).as(&quot;id&quot;)
	                .first(&quot;nome&quot;).as(&quot;nome&quot;)
	                .first(&quot;descricao&quot;).as(&quot;descricao&quot;)
	                .first(&quot;endereco&quot;).as(&quot;endereco&quot;)
	                .first(&quot;empresa&quot;).as(&quot;empresa&quot;)
	                .first(&quot;idCliente&quot;).as(&quot;idCliente&quot;),project().andExclude(&quot;_id&quot;)
	                );
	        
//,project().andExclude(&quot;_id&quot;)
			List&lt;Reclamacao&gt; singleResults = mongoOperations.aggregate(newAggregation, Reclamacao.class, Reclamacao.class).getMappedResults().stream().map(item -&gt; item).collect(Collectors.toList());
			
			
			
			for (Reclamacao teste : singleResults) {
				System.out.println(teste);
			}
			
			return singleResults;
	    }
	    
	     */



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>